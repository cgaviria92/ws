<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego WebSocket con Múltiples Jugadores</title>
    <style>
        #game-container {
            width: 400px;
            height: 400px;
            border: 2px solid black;
            position: relative;
        }
        .player {
            width: 20px;
            height: 20px;
            position: absolute;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<h1>Juego WebSocket - Múltiples Jugadores</h1>
<p>Cada jugador tiene un color único. Usa las flechas para moverte.</p>

<div id="game-container"></div>

<script>
    let socket = new WebSocket("ws://" + window.location.host + "/ws/game/");
    let gameContainer = document.getElementById("game-container");
    let playerId = null;  // Se asignará desde el servidor
    let players = {};

    socket.onopen = function () {
        console.log("Conectado al WebSocket.");
    };

    socket.onmessage = function (e) {
        let data = JSON.parse(e.data);

        if (data.action === "assign_id") {
            playerId = data.player_id;  // Guardamos nuestro ID
        }

        if (data.action === "update_players") {
            updatePlayers(data.players);
        }
    };

    function updatePlayers(playersData) {
        for (let id in playersData) {
            let player = players[id];

            if (!player) {
                // Crear un nuevo jugador si no existe en el frontend
                player = document.createElement("div");
                player.classList.add("player");
                player.style.backgroundColor = playersData[id].color;
                gameContainer.appendChild(player);
                players[id] = player;
            }

            // Actualizar posición
            player.style.left = playersData[id].position.x + "px";
            player.style.top = playersData[id].position.y + "px";
        }

        // Remover jugadores que ya no están activos
        for (let id in players) {
            if (!(id in playersData)) {
                gameContainer.removeChild(players[id]);
                delete players[id];
            }
        }
    }

    // Manejar movimiento del jugador con el teclado
    document.addEventListener("keydown", function (event) {
        if (!playerId || !players[playerId]) return;

        let player = players[playerId];
        let x = parseInt(player.style.left) || 0;
        let y = parseInt(player.style.top) || 0;

        switch (event.key) {
            case "ArrowUp": y = Math.max(y - 10, 0); break;
            case "ArrowDown": y = Math.min(y + 10, 380); break;
            case "ArrowLeft": x = Math.max(x - 10, 0); break;
            case "ArrowRight": x = Math.min(x + 10, 380); break;
        }

        // Enviar el nuevo estado del jugador al servidor
        socket.send(JSON.stringify({
            action: "move",
            x: x,
            y: y
        }));
    });

</script>

</body>
</html>
